
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
    <title>Scarlett</title>
    <script src="node_modules/stanza.io/build/stanzaio.bundle.js"></script>
    <script type="text/javascript" src="js/require.js"></script>
    <script type="text/javascript" src="js/translator.js"></script>
    <script type="text/javascript" src="js/config.js"></script>
    <script type="text/javascript" src='js/state-machine.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/flat-index-conf2.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.conversejs.org/css/converse.min.css">
</head>

<body style="height: 100%">


<!-- Page Layout -->
<style>
#overlaytext{
    position: absolute;
    top: 30%;
    left: 50%;
    font-size: 24px;
    color: black;
    transform: translate(-50%,-50%);
    -ms-transform: translate(-50%,-50%);
    background-color:#DDD;
    padding:20px;
    border-radius: 25px;
}
#overlaybutton{
    position: absolute;
    top: 60%;
    left: 50%;
    font-size: 20px;
    width: 10%;
    color: black;
    transform: translate(-50%,-50%);
    -ms-transform: translate(-50%,-50%);
}
</style>
<div id="overlay">
  <div id="overlaytext">
    <div style="font-size:16px;">
    Contact:
    <br>Meghan Clark (mclarkk@berkeley.edu)
    <br>PhD Student
    <br>Electrical Engineering and Computer Science
    <br>University of California, Berkeley
    <br>
    <br>Research Study Purpose:
    <br>To study the impact of different natural language interfaces on the ability to complete tasks in a smart space.
    <br>
    <br>There will be two phases, a task phase and then a questionnaire phase. Should take X to complete.
    <br>
    <br>Your payment depends on completion of the questionnaire at the end.
    <br>
    <br>Your anonymous data will be shared with other researchers and kept indefinitely.
    <br>
    <br>If you want us to delete your data, please send a message via Mechanical Turk or email mclarkk@berkeley.edu with this user id: XXX
    <br>
    <br>You WILL need to do this on a computer with a big enough screen.
    </div>
  </div>
  <button id="overlaybutton">I have read this and consent</button>
</div>
<div id="questionnaire-overlay">
  <div id="overlaytext">Congratulations! You have completed the last task! To get credit, please answer some questions about your experience: <a id="surveylink" href="https://google.com">Survey</a></div>
</div>
</div>
<style>
#scenario{
  width: 100%;
  height: 80px;
  color: white;
  background-color: rgba(0,0,0,0.6);
  margin-bottom: 10px;
  margin-top: 10px;
}
</style>
<div style="font-color: blue; font-size: 50px; text-align: center;">
  Smart Room Chatroom
  <div style="font-size: 30px;">
    User ID: XXX
  </div>
</div>
<div id="scenario" style="margin-left: 50px; margin-right: 50px; width: 90%; padding: 10px; font-size: 24px;">
</div>
<div style="margin-left:50px;">
  <!-- conference room simulation -->
  <div style="background-image:url('./img/conf1.jpeg'); background-size: 100%; width: 60%; background-repeat: no-repeat; float:left; position:relative; margin-top:20px;">
      <div style="position:relative; left:0; top:0;">
          <img id="lights-image" src='./img/conf1-lights-on.png' style="width: 100%;"/>
      </div>
    <div style="position:absolute; left:0; top:0;">
          <img id="projector-image" src='./img/conf1-projector-off.png' style="width: 100%;"/>
      </div>
  </div>

  <!-- phone interface-->
  <div style="float:right; top: 0; width:40%; position:relative">
    <div id="phone-interface" style="position:relative; margin-left:10%;">
      <img id="phone" src="./img/smartphone2.png" style="position:absolute; top:0; left:0;width:70%;"/>
      <div id="interface" style="position:absolute; top: 0; left:0; margin-top: 10%; margin-left:2.2%; width:66.1%;">
        <div style="position:relative; height:37em;">

        <!-- interface title -->
        <div id="header">
         Ok, Scarlett...
        </div>

        <!-- chat history box -->
        <div id="history" align="center">
          <textarea id="history_box" style="width: 98%; height: 300px;" readonly="readonly" disabled="disabled"> </textarea>

        </div>

        <!-- chat entry box-->
        <div id="inputs" align="center" style="margin-bottom:46%;">
          <form>
            <div class = "container">
              <input type="text" id="user_input" onkeyup="showResult(this.value.toLowerCase())" onfocusout="clearSuggestions()" onfocus="showResult(this.value.toLowerCase())">
              <button id="parse" class="button" type="button">&#9655;</button><!-- filled in: &#9654; outline: &#9655;-->
            </div>

            <div style="width: 96%; display: table;">
            <div style="display: table-row">
                <div style="display: table-cell;"><div id="autocomplete" class="suggestions"></div></div>
                <div style="display: table-cell;width:60px;"></div>
            </div>
            </div>
          </form>
        </div>
        <div align="center" style="margin-top:10px;">
           <div id="tokens" style="width:96%;text-align:left;"><br></div>
           <div id="treediv" style="width:96%;text-align:left;"></div>
        </div>
        <div style:"top:50%"></div>
      </div>
      </div>
    </div>
  </div>

  <div style="clear: both;"></div>
</div>




<!-- Login Info Layout -->

<div id="settings">
  <form id="loginInfo">
    <label>User: <input id="user" type="text" name="user"/></label>
    <label>Password: <input id="password" type="password" name="password" /></label>
    <input id="connect" type="button" value="Connect" />
    <label id="connection_status">Disconnected</label>
  </form>
</div>




<!-- XMPP Client -->

<script>
  var client = null;
  var loginInfo = document.getElementById('connect');
  loginInfo.onclick = function (e) {
    console.log("clicked connect")
    if (e.preventDefault) e.preventDefault();

    var user = document.getElementById('user').value;
    var jid = user + "@" + domain;
    console.log(jid);

    if (client !== null) {
      client.disconnect();
    }

    client = XMPP.createClient({
      jid: jid,
      password: document.getElementById('password').value,

      // If you have a .well-known/host-meta.json file for your
      // domain, the connection transport config can be skipped.

      transport: 'websocket',
      wsURL: wsURL
      // (or `boshURL` if using 'bosh' as the transport)
  });

  client.on('session:started', function () {
    console.log("Started XMPP session")
    document.getElementById('connection_status').innerHTML = "Connected as " + user;
      document.getElementById("history_box").innerHTML = "";
      client.joinRoom(chatroom + "@conference." + domain, user, {joinMuc: {history: {maxstanzas: 20}}} );
      client.getRoster();
      client.sendPresence();
      client.enableCarbons(function (err) {
              if (err) {
                  console.log('Server does not support carbons');
              }
          });
  });

  client.on('message', function (msg) {
    console.log("hit on 'message'");
    console.log(msg);
    //console.log("From: " + msg.from.resource + " Msg: " + msg.body);
    if ("delay" in msg) {
      var d = new Date(Date.parse(msg.delay.stamp));
      timestring = d.toLocaleString();
      timecolumn = timestring + Array(24 - timestring.length).join(" ");
      fromstring = msg.from.resource;
      fromcolumn = fromstring + ":" + Array(15 - fromstring.length).join(" ");
      var record = timecolumn + "\n" + fromstring + ": "  + msg.body + "\n";
      //var record = fromstring + ": "  + msg.body;
      console.log(record);
      document.getElementById("history_box").innerHTML = document.getElementById("history_box").innerHTML + record + "\n";
      document.getElementById("history_box").scrollTop = document.getElementById("history_box").scrollHeight;
    } else if ("body" in msg){
      var d = new Date(); //"Wed Mar 25 2015 09:56:24 GMT+0100 (W. Europe Standard Time)"
      timestring = d.toLocaleString();
      timecolumn = timestring + Array(24 - timestring.length).join(" ");
      fromstring = msg.from.resource;
      fromcolumn = fromstring + ":" + Array(15 - fromstring.length).join(" ");
      //var record = timecolumn + fromcolumn + msg.body;
      var record = timecolumn + "\n" + fromstring + ": "  + msg.body + "\n";
      //var record = fromstring + ": "  + msg.body;
      console.log(record);
      document.getElementById("history_box").innerHTML = document.getElementById("history_box").innerHTML + record + "\n";
      document.getElementById("history_box").scrollTop = document.getElementById("history_box").scrollHeight;
    };
    //console.log(msg.body);
  });

  client.on('chat', function (msg) {
    console.log("hit on 'chat'");
    //  client.sendMessage({
    //    to: msg.from,
    //    body: 'You sent: ' + msg.body
    //  });
  });

  client.on('raw:incoming', function (msg) {
  //  console.log("hit on 'raw:incoming'");
  //  console.log(msg);
    //  client.sendMessage({
    //    to: msg.from,
    //    body: 'You sent: ' + msg.body
    //  });
  });

  client.connect();
  return false;
};
  </script>


<!-- Key Events -->

<script>
  // $(document).ready(function() {
  //   $(window).keydown(function(event){
  //     if(event.keyCode == 13) {
  //       event.preventDefault();
  //       document.getElementById("parse").click();
  //       return false;
  //     }
  //   });
  // });

  var scenario1 = "<b>Scenario 1/3:</b> You are in an empty conference room and preparing for a presentation. You have hooked up your laptop to present slides, but as you look at the room, you can see that nothing is displayed to the audience yet. Use the phone's chat app to tell Scarlett, the building's friendly artificial intelligence, what to do next.";
  var scenario2 = "<b>Scenario 2/3:</b> There is glare on the projector screen that makes it difficult to see the slides. Work with Scarlett to eliminate the glare.";
  var scenario3 = "<b>Scenario 3/3:</b> The audience want to be able to see their stuff. Use the interface to make sure that there is no glare on the projector AND the audience can see their stuff.";

  var fsm = new StateMachine({
    init: 'init',
    transitions: [
      { name: 'startOnboard',       from: 'init',  to: 'onboarding' },
      { name: 'startScenario1',     from: 'onboarding', to: 'scenario1'},
      { name: 'startTasks1',        from: 'scenario1', to: 'tasks1'},
      { name: 'startScenario2',     from: 'tasks1', to: 'scenario2'},
      { name: 'startTasks2',        from: 'scenario2', to: 'tasks2'},
      { name: 'startScenario3',     from: 'tasks2', to: 'scenario3'},
      { name: 'startTasks3',        from: 'scenario3', to: 'tasks3'},
      { name: 'startQuestionnaire', from: 'tasks3', to: 'questionnaire'    }
    ],
    methods: {
      onStartOnboard:       function() {
        document.getElementById("overlay").style.display = "block";
      },
      onStartScenario1:     function() {
        document.getElementById("overlaytext").innerHTML = scenario1;
        document.getElementById("scenario").innerHTML = "";
        document.getElementById("overlaybutton").innerHTML = "Let's do it";
      },
      onStartTasks1:        function() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("scenario").innerHTML = scenario1;
      },
      onStartScenario2:     function() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("overlaytext").innerHTML = scenario2;
        document.getElementById("scenario").innerHTML = "";
        document.getElementById("overlaybutton").innerHTML = "Let's do it";
      },
      onStartTasks2:        function() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("scenario").innerHTML = scenario2;
      },
      onStartScenario3:     function() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("overlaytext").innerHTML = scenario3;
        document.getElementById("scenario").innerHTML = "";
        document.getElementById("overlaybutton").innerHTML = "Let's do it";
      },
      onStartTasks3:        function() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("scenario").innerHTML = scenario3;
      },
      onStartQuestionnaire: function() {
        document.getElementById("questionnaire-overlay").style.display = "block";
      }
    }
  });

  fsm.startOnboard();

  document.getElementById("overlaybutton").addEventListener("click", function(){
    if (fsm.state == 'onboarding') { fsm.startScenario1(); }
    else if (fsm.state == 'scenario1') { fsm.startTasks1(); }
    else if (fsm.state == 'scenario2') { fsm.startTasks2(); }
    else if (fsm.state == 'scenario3') { fsm.startTasks3(); }
  });

  var PHASE = 0;

  document.onkeydown = function (e) {
  switch (e.keyCode) {
    case 13:
      console.log("Enter key");
      e.preventDefault();
      document.getElementById("parse").click();
      break;
    case 37:
      console.log('Go to the previous page!');
      break;
    case 39:
      console.log('Got to the next page');
      break;

    default:
      console.log('DEFAULT KEYLOG');
      console.log(e.keyCode);
      return; // Do nothing for the rest
  }
};
</script>




<!-- Autocomplete -->

<script type="text/javascript">
  // select interface
  var user_id = 0
  //var interface_id = Math.floor(Math.random() * (maximum - minimum + 1)) + minimum;
  var interface_id = user_id % 9;

  var survey_link = "https://google.com?user=" + user_id.toString() + "&interface=" + interface_id.toString();

  document.getElementById("surveylink").href = survey_link;

  //Thanks to http://tomassetti.me/antlr-and-the-web/
  var updateTree = function(tree, ruleNames) {
      var container = document.getElementById("treediv");
      while (container.hasChildNodes()) {
          container.removeChild(container.lastChild);
      }
      recurseTree(container, tree, ruleNames)
  };

  var recurseTree = function(container, tree, ruleNames) {
      if (tree.children !== undefined && tree.children != null) {
          for (var i = 0; i < tree.children.length; i++) {
              var child = tree.children[i];
              recurseTree(container, child, ruleNames);
          }
          var nodeType = ruleNames[tree.ruleIndex];
          var newElement = document.createElement("div");
          newElement.className = "NearbyApplication";
          var newElementText = document.createTextNode(nodeType);//child.children[2].getText());
          newElement.appendChild(newElementText);
          container.appendChild(newElement);
      }
  };

  var ErrorListener = require('antlr4/error/ErrorListener').ErrorListener;
  function TestGrammarErrorListener() {
      ErrorListener.call(this);
      this.partialApplication = null;
      this.errors = [];
      return this;
  }

  TestGrammarErrorListener.prototype = Object.create(ErrorListener.prototype);
  TestGrammarErrorListener.prototype.constructor = TestGrammarErrorListener;

  var testTokens; //TEST global for console stuff
  var testParser;
  TestGrammarErrorListener.prototype.syntaxError = function(recognizer, offendingSymbol, line, column, msg, e) {
      this.errors.push(arguments);
      console.log("PARSER ERROR");
      console.log(msg);
      var parser = recognizer._ctx.parser;
      testParser = recognizer._ctx.parser;
      testTokens = parser.getExpectedTokens(); //CRITICAL. This is an interval set with the numbers that correspond to the expected token types
      tokenString = testTokens.toString(); //String like '{1..2, 4..9}' or '8..9'
       console.log(tokenString);
       var tokenStrArray = tokenString.replace('{', '').replace('}', '').split(", "); //Array of strings like ['1..2', '4..9']
       var tokenArray = [];
       console.log(tokenStrArray);
       for (i = 0; i < tokenStrArray.length; i++) {
           intInterval = tokenStrArray[i];
           if (intInterval.indexOf('..') !== -1) {
               var endpoints = intInterval.split('..');
               var start = parseInt(endpoints[0], 10);
               var end = parseInt(endpoints[1], 10);
               for (j = start; j < end+1; j++) {
                   tokenArray.push(j);
               }
           } else {
               tokenArray.push(parseInt(intInterval, 10));
           }
       }
      console.log(tokenArray);
       // End interval set to array of integers conversion
       // Begin convert from array of integers to array of symbolic names
       for (i in tokenArray) {
           tokenArray[i] = parser.symbolicNames[parseInt(tokenArray[i], 10)];
       }
       console.log(tokenArray);
       // End conversion from integers to symbolic names

       this.partialApplication = null;
       var typeAssistTokens = parser.symbolicNames;
       var tokens = parser.getTokenStream().tokens;

      // last token is always "fake" EOF token
      if (tokens.length > 1) {
          var lastToken = tokens[tokens.length - 2],
              tokenType = parser.symbolicNames[lastToken.type];

          this.tokenType = tokenType;
          if (typeAssistTokens.indexOf(tokenType) >= 0) {
              this.partialApplication = lastToken.text;
              console.log("partial application: " + this.partialApplication);
          }
     }

  //    if (str.length==0) {
  //        document.getElementById("autocomplete").innerHTML="";
  //        document.getElementById("autocomplete").style.border="0px";
  //        return;
  //    } else {
          if (window.XMLHttpRequest) {
              // code for IE7+, Firefox, Chrome, Opera, Safari
              xmlhttp=new XMLHttpRequest();
          } else {  // code for IE6, IE5
              xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
          }
          xmlhttp.onreadystatechange=function() {
              if (xmlhttp.readyState==4 && xmlhttp.status==200) {
                document.getElementById("autocomplete").innerHTML=xmlhttp.responseText;
                document.getElementById("autocomplete").style.border="1px solid #A5ACB2";
                document.getElementById("autocomplete").style.fontSize="larger";
                document.getElementById("autocomplete").style.backgroundColor = "rgba(255, 255, 255, 1)";
  	    }
          }
          var qString = "php/autocomplete.php?";
          for (i in tokenArray) {
              qString += "q[]=_" + tokenArray[i] + "&";
          }
          var text = "";
          for (i in tokens) {
              if (i < tokens.length - 1) {
                 text += tokens[i].text + " ";
              }
          }
          //text = document.getElementById("user_input").value;
          qString += "text=" + text;
          console.log(qString);
          xmlhttp.open("GET",qString,true);
          xmlhttp.send();
   //   }
  };

  // Send message to chatroom
  function submitMessage(msg) {
      client.sendMessage({to: "test_room@conference."+ domain, body: msg, type: 'groupchat'});
  };

  // Remove suggestions
  function clearSuggestions() {
      document.getElementById("autocomplete").innerHTML="";
      document.getElementById("autocomplete").style.border="0px solid #A5ACB2";
      document.getElementById("autocomplete").style.backgroundColor = "rgba(255, 255, 255, 0)";
  }

  var antlr4 = require('antlr4/index');
  var NearbyLexer = require('generated-parser/NearbyLexer');
  var NearbyParser = require('generated-parser/NearbyParser');

  var sim_room = {
    front_cans: null,
    side_cans: null,
    ambient: null,
    overhead: null,
    the_lights: null,
    projector: null,
    right_blinds: null,
    left_blinds: null,
    the_blinds: null,
    temp: null,
    humidity: null,
    pressure: null,

  };

  document.getElementById("parse").addEventListener("click", function(){
      //submitMessage(document.getElementById("user_input").value);
      var input = document.getElementById("user_input").value.toLowerCase();

      if (input == "turn on the lights") {
        console.log("changing light image to on");
        document.getElementById("lights-image").src="./img/conf1-lights-on.png";
      } else if (input == "turn off the lights") {
        console.log("changing light image to off");
        document.getElementById("lights-image").src="./img/conf1-lights-off.png";
      } else if (input == "turn on the projector") {
        console.log("changing projector to on");
        document.getElementById("projector-image").src="./img/conf1-projector-on.png";
      } else if (input == "turn off the projector") {
        console.log("changing projector to off");
        document.getElementById("projector-image").src="./img/conf1-projector-off.png";
      }

      var chars = new antlr4.InputStream(input);
      var lexer = new NearbyLexer.NearbyLexer(chars);
      var tokens  = new antlr4.CommonTokenStream(lexer);
      var parser = new NearbyParser.NearbyParser(tokens);
      var listener = new TestGrammarErrorListener();
      parser.removeErrorListeners();
      parser.addErrorListener(listener);
      parser.buildParseTrees = true;
      var tree = parser.application();
      //updateTree(tree, parser.ruleNames);
      var translator = new TargetTranslator();
      antlr4.tree.ParseTreeWalker.DEFAULT.walk(translator, tree);
      console.log(translator.target_sentence);
      var str_json = JSON.stringify(translator.target_sentence);
      //var request = new XMLHttpRequest();
      //request.open("POST", "php/post-to-target.php", true);
      //request.setRequestHeader("Content-type", "application/json");
      //request.send(str_json);

      document.getElementById("user_input").value = "";
      if (fsm.state == 'tasks1') { fsm.startScenario2(); }
      else if (fsm.state == 'tasks2') { fsm.startScenario3(); }
      if (fsm.state == 'tasks3') { fsm.startQuestionnaire(); }
  });

  //var BailErrorStrategy = require('antlr4/error/ErrorStrategy').BailErrorStrategy;

  function showResult(str) {
      var input = str;
      var chars = new antlr4.InputStream(input);
      var lexer = new NearbyLexer.NearbyLexer(chars);
      var tokens  = new antlr4.CommonTokenStream(lexer);
      var parser = new NearbyParser.NearbyParser(tokens);
      var listener = new TestGrammarErrorListener();
      parser.removeErrorListeners();
      parser.addErrorListener(listener);
      parser.buildParseTrees = true;
      //parser._errHandler = new BailErrorStrategy();
      console.log(parser._errHandler); //TEST
      var tree = parser.application();
      //updateTree(tree, parser.ruleNames);

     document.getElementById("autocomplete").innerHTML="";
     document.getElementById("autocomplete").style.border="0px";

      var tokens = parser.getTokenStream().tokens;
      tokens = tokens.slice(0,tokens.length-1);

      var tokenString = "";
      for (i in tokens) {
          tokenString += parser.symbolicNames[tokens[i].type] + " ";
      }
      //document.getElementById("tokens").innerHTML=tokenString;
  }

  </script>

</body>
</html>
